const preset = {
  negado: {
    color: "#FB3640",
    image: "denied.webp",
    background:
      "linear-gradient(90deg, rgba(251, 54, 64, 0.1) 0%, rgba(251, 54, 64, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(251, 54, 64, 0.4) 0%, rgba(251, 54, 64, 0.0375) 85.42%, rgba(251, 54, 64, 0) 100%)",
  },

  amor: {
    color: "#FB3640",
    image: "love.png",
    background:
      "linear-gradient(90deg, rgba(251, 54, 64, 0.1) 0%, rgba(251, 54, 64, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(251, 54, 64, 0.4) 0%, rgba(251, 54, 64, 0.0375) 85.42%, rgba(251, 54, 64, 0) 100%)",
  },

  airdrop: {
    color: "#E0BE36",
    image: "airdrop.png",
    background:
      "linear-gradient(90deg, rgba(224, 190, 54, 0.1) 0%, rgba(224, 190, 54, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(224, 190, 54, 0.4) 0%, rgba(224, 190, 54, 0.0375) 85.42%, rgba(224, 190, 54, 0) 100%)",
  },

  dica: {
    color: "#E0BE36",
    image: "bulb.png",
    background:
      "linear-gradient(90deg, rgba(224, 190, 54, 0.1) 0%, rgba(224, 190, 54, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(224, 190, 54, 0.4) 0%, rgba(224, 190, 54, 0.0375) 85.42%, rgba(224, 190, 54, 0) 100%)",
  },

  sucesso: {
    color: "#44AF69",
    image: "success.webp",
    background:
      "linear-gradient(90deg, rgba(68, 175, 105, 0.1) 0%, rgba(68, 175, 105, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(68, 175, 105, 0.4) 0%, rgba(68, 175, 105, 0.0375) 85.42%, rgba(68, 175, 105, 0) 100%)",
  },

  importante: {
    color: "#E0BE36",
    image: "warn.webp",
    background:
      "linear-gradient(90deg, rgba(224, 190, 54, 0.1) 0%, rgba(224, 190, 54, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(224, 190, 54, 0.4) 0%, rgba(224, 190, 54, 0.0375) 85.42%, rgba(224, 190, 54, 0) 100%)",
  },

  azul: {
    color: "#669AE1",
    image: "info.webp",
    background:
      "linear-gradient(90deg, rgba(102, 154, 225, 0.1) 0%, rgba(102, 154, 225, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(102, 154, 225, 0.4) 0%, rgba(102, 154, 225, 0.0375) 85.42%, rgba(102, 154, 225, 0) 100%)",
  },

  sangramento: {
    color: "#FB3640",
    image: "blood.webp",
    background:
      "linear-gradient(90deg, rgba(251, 54, 64, 0.1) 0%, rgba(251, 54, 64, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(251, 54, 64, 0.4) 0%, rgba(251, 54, 64, 0.0375) 85.42%, rgba(251, 54, 64, 0) 100%)",
  },

  compras: {
    color: "#nFF9FE5",
    image: "buyer.svg",
    background:
      "linear-gradient(90deg, rgba(255, 159, 229, 0.1) 0%, rgba(255, 159, 229, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(255, 184, 29, 0.4) 0%, rgba(255, 159, 229, 0.4) 0.01%, rgba(255, 159, 229, 0.0375) 85.42%, rgba(255, 159, 229, 0) 100%)",
  },

  fome: {
    color: "#F17300",
    image: "hungry.webp",
    background:
      "linear-gradient(90deg, rgba(241, 115, 0, 0.1) 0%, rgba(241, 115, 0, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(241, 115, 0, 0.4) 0%, rgba(241, 115, 0, 0.0375) 85.42%, rgba(241, 115, 0, 0) 100%)",
  },

  sede: {
    color: "#669AE1",
    image: "thirst.webp",
    background:
      "linear-gradient(90deg, rgba(102, 154, 225, 0.1) 0%, rgba(102, 154, 225, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(102, 154, 225, 0.4) 0%, rgba(102, 154, 225, 0.0375) 85.42%, rgba(102, 154, 225, 0) 100%)",
  },

  police: {
    color: "#669AE1",
    image: "police.webp",
    background:
      "linear-gradient(90deg, rgba(102, 154, 225, 0.1) 0%, rgba(102, 154, 225, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(102, 154, 225, 0.4) 0%, rgba(102, 154, 225, 0.0375) 85.42%, rgba(102, 154, 225, 0) 100%)",
  },

  paramedic: {
    color: "#FB3640",
    image: "paramedic.webp",
    background:
      "linear-gradient(90deg, rgba(251, 54, 64, 0.1) 0%, rgba(251, 54, 64, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(251, 54, 64, 0.4) 0%, rgba(251, 54, 64, 0.0375) 85.42%, rgba(251, 54, 64, 0) 100%)",
  },

  admin: {
    color: "#E0BE36",
    image: "admin.webp",
    background:
      "linear-gradient(90deg, rgba(224, 190, 54, 0.1) 0%, rgba(224, 190, 54, 0) 97.94%)",
    lightBackground:
      "radial-gradient(50% 50% at 50% 50%, rgba(224, 190, 54, 0.4) 0%, rgba(224, 190, 54, 0.0375) 85.42%, rgba(224, 190, 54, 0) 100%)",
  },
};

$(() => {
  // Inicialização do Menu de Ajuda
  initializeHelpMenu();

  window.addEventListener("message", async (event) => {
    const item = event.data || event.detail;
    switch (item.Action) {
      case "Notify":
        var Html = `
                <div class="notify" style=>
                    <div class="notify_style" style="background:${
                      preset[item.Css].background
                    }">
                        <div class="notify_light" style="background:${
                          preset[item.Css].lightBackground
                        }">
                        </div>
                        <div class="notify_content"
                            style="flex-direction:${
                              !item.Title ? "row" : "column"
                            };gap: ${!item?.title && "0.1vw"}">
                            <div class="notify_title">
                                ${
                                  item.Title
                                    ? `<h1 style="color:${
                                        preset[item.Css].color
                                      }">
                                    ${item.Title}
                                </h1>`
                                    : ""
                                }
                                ${
                                  preset[item.Css].image != "compras"
                                    ? `<img src="./assets/images/${
                                        preset[item.Css].image
                                      }" alt="notify">`
                                    : ""
                                }
                            </div>
                            <p class="notify_text">${
                              preset[item.Css].image === "compras"
                                ? `<img style="margin-right: 10px; margin-bottom: 5px;" src="./assets/images/${
                                    preset[item.Css].image
                                  }" alt="notify">`
                                : ""
                            } ${item?.Message}</p>
                        </div>
                        <div class="notify_bar">
                            <div class="notify_fill"
                                style="animation-duration:${
                                  (item?.Timer || 3000) / 1000 + "s"
                                };background:${preset[item.Css].color}">
                            </div>
                        </div>
                    </div>
                </div>`;

        // Oculta o menu de ajuda quando uma notificação aparece
        $("#help-menu").hide();

        $("#notifys").animate(
          { scrollTop: $("#notifys").prop("scrollHeight") },
          100,
          "swing"
        );

        $(Html)
          .appendTo("#notifys")
          .animate({ left: "0", opacity: 1 }, { duration: 500 })
          .delay(item.Timer)
          .animate(
            { left: "-10vw", opacity: 0 },
            {
              duration: 500,
              complete: function () {
                this.remove();
              },
            }
          );
        break;

      case "Text":
        if (item?.Message == "") {
          $("#texts").empty();
          return;
        }
        var Html = `
                ${
                  (item?.Message != "" &&
                    `
                    <div class="Text" style=>
                        <h1>
                            ${item?.Message}
                        </h1>
                    </div>+
                }`) ||
                  ""
                } `;
        $("#texts").animate(
          { scrollTop: $("#texts").prop("scrollHeight") },
          100,
          "swing"
        );
        $(Html)
          .appendTo("#texts")
          .animate({ left: "0", opacity: 1 }, { duration: 500 });
        break;

      case "Announce":
        var Html = `
                    <div class="announce" >
                        <div class="notify_style" style="background:${
                          preset[item.Css].background
                        }">
                            <div class="notify_light" style="background:${
                              preset[item.Css].lightBackground
                            }">
                            </div>
                            <div class="notify_content"
                                style="flex-direction:${
                                  !item.Title ? "row" : "column"
                                };gap: ${!item?.title && "0.5vw"}">
                                <div class="notify_title">
                                    ${
                                      item.Title
                                        ? `<h1 style="color:${
                                            preset[item.Css].color
                                          }">
                                        ${item.Title}
                                    </h1>`
                                        : ""
                                    }
                                    <img src='./assets/images/${
                                      preset[item.Css].image
                                    }')" />
                                </div>
                                <p class="notify_text">${item?.Message}</p>
                            </div>
                            <div class="notify_bar">
                                <div class="notify_fill"
                                    style="animation-duration:${
                                      (item?.Timer || 3000) / 1000 + "s"
                                    };background:${preset[item.Css].color}">
                                </div>
                            </div>
                        </div>
                    </div > `;

        // Oculta o menu de ajuda quando um anúncio aparece
        $("#help-menu").hide();

        $("#announces").animate(
          { scrollTop: $("#announces").prop("scrollHeight") },
          100,
          "swing"
        );
        $(Html)
          .appendTo("#announces")
          .animate({ right: "0", opacity: 1 }, { duration: 500 })
          .delay(item.Timer)
          .animate(
            { right: "-10vw", opacity: 0 },
            {
              duration: 500,
              complete: function () {
                this.remove();
              },
            }
          );
        break;

      case "Tutorial":
        if (item.Status) {
          $("#help-menu").fadeIn(500);
          $("#notifys").html("");

          // Se houver um pedido explícito de reset ou estamos abrindo o menu, mostrar a tela principal
          if (item.Reset || !$("#help-menu").is(":visible")) {
            resetToMainScreen();
          }

          // Habilitar cursor para interação com o menu - com tentativa de retentativa
          $.post("https://cordova_notify/enableCursor", JSON.stringify({}));
          // Garantir que o cursor seja realmente ativado após um pequeno atraso
          setTimeout(function () {
            $.post("https://cordova_notify/enableCursor", JSON.stringify({}));
          }, 100);
          return;
        }
        $("#help-menu").fadeOut(500);
        // Desabilitar cursor quando o menu é fechado - múltiplas tentativas para garantir
        $.post("https://cordova_notify/disableCursor", JSON.stringify({}));
        // Tentar novamente após um breve delay para garantir
        setTimeout(function () {
          $.post("https://cordova_notify/disableCursor", JSON.stringify({}));
        }, 100);
        setTimeout(function () {
          $.post("https://cordova_notify/disableCursor", JSON.stringify({}));
        }, 300);
        break;
    }
  });
});

// Inicialização do Menu de Ajuda
function initializeHelpMenu() {
  // Ocultar menu de ajuda inicialmente
  $("#help-menu").hide();

  // Mostrar apenas a tela principal e esconder as outras
  $(".screen").hide();
  $("#main-screen").show();

  // Garantir que o cursor permaneça ativado enquanto o menu estiver aberto
  setInterval(function () {
    if ($("#help-menu").is(":visible")) {
      $.post("https://cordova_notify/enableCursor", JSON.stringify({}));
    }
  }, 2000); // Verificar a cada 2 segundos

  // Garantir estrutura básica para cada tela
  function ensureScreenStructure() {
    // Para cada tela (exceto a principal)
    $(".screen")
      .not("#main-screen")
      .each(function () {
        var screenId = $(this).attr("id");

        // 1. Se não tiver cabeçalho (screen-header), adicionar um básico
        if ($(this).find(".screen-header").length === 0) {
          $(this).prepend(`
          <div class="screen-header">
            <div class="screen-title">
              <i class="fas fa-info-circle"></i>
              <span>Informação</span>
            </div>
            <button class="back-button" data-target="main-screen">
              <i class="fas fa-arrow-left"></i> Voltar
            </button>
          </div>
        `);
        }

        // 2. Se não tiver breadcrumb, adicionar um básico
        if ($(this).find(".breadcrumb").length === 0) {
          $(this).find(".screen-header").after(`
          <div class="breadcrumb">
            <span>Menu</span> <i class="fas fa-chevron-right"></i> <span>Informação</span>
          </div>
        `);
        }

        // 3. Garantir pelo menos uma seção de detalhes
        if ($(this).find(".detail-section").length === 0) {
          if ($(this).find(".category-content").length === 0) {
            $(this).append(`
            <div class="detail-section">
              <h3>Informações</h3>
              <p>Sem informações adicionais disponíveis no momento.</p>
            </div>
          `);
          }
        }

        // 4. Garantir que tenha botão home
        if ($(this).find(".home-button").length === 0) {
          $(this).append(`
          <button class="home-button">
            <i class="fas fa-home"></i> Menu Principal
          </button>
        `);
        }
      });
  }

  // Executar a verificação de estrutura na inicialização
  ensureScreenStructure();

  // Função para resetar o menu para a tela principal
  function resetToMainScreen() {
    $(".screen").hide();
    $("#main-screen").fadeIn(300);
  }

  // Função para mostrar uma tela específica
  function showScreen(screenId) {
    // Ocultar todas as telas
    $(".screen").hide();

    // Verificar se o elemento existe
    if ($("#" + screenId).length > 0) {
      // Mostrar a tela solicitada
      $("#" + screenId).fadeIn(300);

      // Garantir que a estrutura está completa
      ensureScreenStructure();
    } else {
      // Criar uma tela temporária de "informação não disponível"
      if (!$("#no-info-screen").length) {
        $("<div>")
          .attr("id", "no-info-screen")
          .addClass("screen")
          .html(
            `
            <div class="screen-header">
              <div class="screen-title">
                <i class="fas fa-exclamation-circle"></i>
                <span>Informação não disponível</span>
              </div>
              <button class="back-button" data-target="main-screen">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
            </div>
            <div class="breadcrumb">
              <span>Menu</span> <i class="fas fa-chevron-right"></i> <span>Informação não disponível</span>
            </div>
            <div class="detail-section">
              <h3>Informação não encontrada</h3>
              <p>As informações sobre este tópico não estão disponíveis no momento ou estão em desenvolvimento.</p>
              <p>Por favor, tente novamente mais tarde ou verifique outras categorias.</p>
            </div>
            <button class="home-button">
              <i class="fas fa-home"></i> Menu Principal
            </button>
          `
          )
          .appendTo("#help-menu");
      }

      // Mostrar a tela de informação não disponível
      $("#no-info-screen").fadeIn(300);

      // Log para depuração
      console.log(
        "Tela não encontrada: " + screenId + " - Mostrando mensagem informativa"
      );
    }
  }

  // Evento para o botão fixo no lado esquerdo
  $("#help-button").on("click", function () {
    $("#help-menu").fadeIn(500);
    resetToMainScreen();
    // Habilitar cursor quando o menu é aberto
    $.post("https://cordova_notify/enableCursor", JSON.stringify({}));
  });

  // Evento para fechar o menu com o botão de fechar
  $("#help-menu-close").on("click", function () {
    $("#help-menu").fadeOut(500);
    // Desabilitar cursor quando o menu é fechado - múltiplas tentativas
    $.post("https://cordova_notify/disableCursor", JSON.stringify({}));
    // Informar ao backend que o menu foi fechado
    $.post("https://cordova_notify/closeMenu", JSON.stringify({}));
    // Tentar novamente após um breve delay para garantir
    setTimeout(function () {
      $.post("https://cordova_notify/disableCursor", JSON.stringify({}));
    }, 100);
  });

  // Evento para cards principais - navegar para tela específica
  $(document).on("click", ".help-card", function () {
    const targetScreen = $(this).data("screen");
    if (targetScreen) {
      showScreen(targetScreen);
    }
  });

  // Evento para subcards - navegar para tela detalhada
  $(document).on("click", ".subcard", function () {
    const targetScreen = $(this).data("screen");
    if (targetScreen) {
      showScreen(targetScreen);
    }
  });

  // Evento para botões de voltar
  $(document).on("click", ".back-button", function () {
    const targetScreen = $(this).data("target");
    if (targetScreen) {
      showScreen(targetScreen);
    }
  });

  // Evento para botão home fixo
  $(document).on("click", ".home-button", function () {
    resetToMainScreen();
  });

  // Tecla de atalho para abrir/fechar o menu (tecla =)
  document.addEventListener("keydown", function (e) {
    if (e.key === "=" || e.code === "Equal") {
      const helpMenu = $("#help-menu");

      if (helpMenu.is(":visible")) {
        helpMenu.fadeOut(500);
        // Desabilitar cursor - múltiplas chamadas para garantir
        $.post("https://cordova_notify/disableCursor", JSON.stringify({}));
        // Informar ao backend que o menu foi fechado
        $.post("https://cordova_notify/closeMenu", JSON.stringify({}));
        // Tentar novamente após um breve delay
        setTimeout(function () {
          $.post("https://cordova_notify/disableCursor", JSON.stringify({}));
        }, 100);
      } else {
        helpMenu.fadeIn(500);
        // Resetar para a tela principal
        resetToMainScreen();
        // Habilitar cursor
        $.post("https://cordova_notify/enableCursor", JSON.stringify({}));
      }
    }

    // Adicionar escape para fechar o menu
    if (e.key === "Escape" || e.code === "Escape") {
      const helpMenu = $("#help-menu");
      if (helpMenu.is(":visible")) {
        helpMenu.fadeOut(500);
        // Desabilitar cursor - múltiplas chamadas para garantir
        $.post("https://cordova_notify/disableCursor", JSON.stringify({}));
        // Enviar evento para o Lua para garantir sincronização
        $.post("https://cordova_notify/closeMenu", JSON.stringify({}));
        // Tentar novamente após um breve delay
        setTimeout(function () {
          $.post("https://cordova_notify/disableCursor", JSON.stringify({}));
        }, 100);
      }
    }

    // Tecla Backspace para voltar à tela anterior
    if (
      (e.key === "Backspace" || e.code === "Backspace") &&
      $("#help-menu").is(":visible")
    ) {
      // Verificar se não estamos na tela principal
      if ($("#main-screen").is(":visible") === false) {
        // Encontrar o botão de voltar na tela atual e simular clique
        const visibleScreen = $(".screen:visible");
        const backButton = visibleScreen.find(".back-button");
        if (backButton.length > 0) {
          // Obter a tela de destino do botão de voltar
          const targetScreen = backButton.data("target");
          if (targetScreen) {
            showScreen(targetScreen);
          } else {
            // Se não tiver destino específico, voltar para a tela principal
            resetToMainScreen();
          }
        } else {
          // Se não encontrar um botão de voltar, voltar para a tela principal
          resetToMainScreen();
        }
        // Prevenir o comportamento padrão do backspace
        e.preventDefault();
      }
    }
  });
}
